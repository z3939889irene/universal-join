<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ é»æ“ŠåŠ å…¥é ˜å–å°ˆå±¬å„ªæƒ </title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
         margin:0;background:#fff;color:#222}
    .wrap{max-width:720px;margin:0 auto;padding:28px}
    h1{font-size:22px;line-height:1.35;margin:0 0 12px}
    .card{border:1px solid #eee;border-radius:14px;padding:22px}
    .hint{color:#555;margin:10px 0 16px}
    .cta{display:block;text-align:center;text-decoration:none;border:0;
         padding:14px 18px;border-radius:12px;font-weight:700;font-size:18px;
         background:#06C755;color:#fff}
    .cta:active{transform:translateY(1px)}
    .muted{color:#888;font-size:13px;margin-top:12px}
    .qr{display:flex;gap:16px;align-items:center;margin-top:16px}
    .qr img{width:160px;height:160px}
    .ok{color:#0a7c2f}
    .err{color:#b00020}
  </style>
  <!-- LIFF SDKï¼ˆåƒ…åœ¨ LINE App å…§æœƒç”¨åˆ°ï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ é»æ“ŠåŠ å…¥é ˜å–å°ˆå±¬å„ªæƒ </h1>

    <div id="view" class="card">
      <p class="hint" id="status">è¼‰å…¥ä¸­â€¦</p>
      <a id="openLineBtn" class="cta" href="#" style="display:none;">ğŸ‘‰ é»æˆ‘è§£é–å„ªæƒ ï¼ˆå°‡è‡ªå‹•é–‹å•Ÿ LINEï¼‰</a>

      <div id="qrBlock" style="display:none;">
        <div class="qr">
          <img id="qrImg" alt="æƒæ QR ä»¥åœ¨ LINE é–‹å•Ÿ" />
          <div>
            <div class="muted">ä½¿ç”¨æ‰‹æ©Ÿ LINE æƒæå·¦å´ QR å³å¯å¸¶å…¥é—œéµå­—</div>
            <div class="muted" id="kwEcho"></div>
          </div>
        </div>
      </div>
    </div>

    <p class="muted">è‹¥æœªè‡ªå‹•é–‹å•Ÿï¼Œè«‹é»ä¸Šæ–¹ç¶ è‰²æŒ‰éˆ•ã€‚</p>
  </div>

<script>
(function () {
  // ====== ä½ çš„è¨­å®š ======
  const LINE_ID   = '@camel-live';          // OA ID
  const LIFF_ID   = '2008415501-DxLWdBGd';  // ä½ çš„ LIFF IDï¼ˆå·²æä¾›ï¼‰
  // ======================

  // å–å¾—é—œéµå­— ?k=
  const usp = new URLSearchParams(location.search);
  const keyword = (usp.get('k') || '').trim();
  const encodedKW = encodeURIComponent(keyword);

  // Deep linkï¼ˆå¤–éƒ¨ç’°å¢ƒï¼æŒ‰éˆ•ï¼å¤±æ•—å‚™æ´ç”¨ï¼‰
  const oaMessageURL = `https://line.me/R/oaMessage/${encodeURIComponent(LINE_ID)}/?${encodedKW}`;

  const $status = document.getElementById('status');
  const $btn    = document.getElementById('openLineBtn');
  const $qrBlk  = document.getElementById('qrBlock');
  const $qrImg  = document.getElementById('qrImg');
  const $kwEcho = document.getElementById('kwEcho');

  function isLineInApp() {
    return /Line\/|NAVER\(inapp; search;/.test(navigator.userAgent);
  }
  function isInAppWebView() {
    const ua = navigator.userAgent;
    return /Instagram|FB_IAB|FBAN|FBAV|Messenger|Line\/|TikTok|KAKAOTALK/i.test(ua);
  }
  function isDesktop() {
    return !/iphone|ipad|ipod|android/i.test(navigator.userAgent);
  }

  // çµ±ä¸€é¡¯ç¤ºæŒ‰éˆ•
  function showOpenButton() {
    $btn.href = oaMessageURL;
    $btn.style.display = 'block';
    $btn.onclick = function (e) {
      e.preventDefault();
      // ä»¥ç›´æ¥å°å‘ç¢ºä¿å¤§å¤šæ•¸ WebView å¯è§¸ç™¼
      window.location.href = oaMessageURL;
      // 1.5 ç§’å¾Œä»æœªè·³èµ° â†’ å†å˜—è©¦æ‰“é–‹æ–°è¦–çª—
      setTimeout(()=>{ window.open(oaMessageURL, '_blank'); }, 1500);
    };
  }

  // æ¡Œæ©Ÿé¡¯ç¤ºã€Œå¸¶é—œéµå­—ã€çš„ QR
  function showQR() {
    $qrBlk.style.display = 'block';
    $kwEcho.textContent = keyword ? `æœ¬æ¬¡é—œéµå­—ï¼š${keyword}` : '';
    const qrTarget = encodeURIComponent(oaMessageURL);
    $qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${qrTarget}`;
  }

// æ²’å¸¶ k â†’ æ¡Œæ©Ÿåªé¡¯ç¤º QRï¼›æ‰‹æ©Ÿé¡¯ç¤ºæŒ‰éˆ•
if (!keyword) {
  if (isDesktop()) {
    $status.textContent = 'è«‹ä½¿ç”¨æ‰‹æ©Ÿ LINE æƒæä¸‹æ–¹ QR é–‹å•Ÿå„ªæƒ ã€‚';
    showQR();
    return;
  }
  $status.textContent = 'æœªåµæ¸¬åˆ°é—œéµå­—ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–¼ LINE é–‹å•Ÿã€‚';
  showOpenButton();
  return;
}

  // LINE App å…§ï¼šç”¨ LIFF è‡ªå‹•é€å­—
  if (isLineInApp()) {
    $status.textContent = 'æ­£åœ¨ä»¥ LIFF è‡ªå‹•ç™¼é€é—œéµå­—â€¦';
    liff.init({ liffId: LIFF_ID }).then(() => {
      return liff.sendMessages([{ type: 'text', text: keyword }]);
    }).then(() => {
      $status.innerHTML = '<span class="ok">å·²ç™¼é€å®Œæˆï¼Œç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼</span>';
      // å¯é¸ï¼šè‡ªå‹•é—œé–‰æˆ–å°å›èŠå¤©
      setTimeout(()=>{ liff.closeWindow?.(); }, 1200);
    }).catch((err) => {
      console.warn('LIFF å¤±æ•—ï¼Œæ”¹ç”¨ deep linkï¼š', err);
      $status.innerHTML = '<span class="err">è‡ªå‹•ç™¼é€æœªæˆåŠŸï¼Œè«‹é»æŒ‰éˆ•æ–¼ LINE é–‹å•Ÿã€‚</span>';
      showOpenButton();
    });
    return;
  }

  // IG/FB/Threads/TikTok ç­‰å…§å»ºç€è¦½å™¨ï¼šä¸å˜—è©¦è‡ªå‹•é€ï¼Œç›´æ¥é¡¯ç¤ºå¤§æŒ‰éˆ•
  if (isInAppWebView()) {
    $status.textContent = 'è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–¼ LINE é–‹å•Ÿä»¥è§£é–å„ªæƒ ã€‚';
    showOpenButton();
    return;
  }

  // ä¸€èˆ¬è¡Œå‹•ç€è¦½å™¨ï¼šç›´æ¥å°å‘ LINEï¼ˆè‹¥è¢«é˜»æ“‹ï¼Œä»æœ‰æŒ‰éˆ•ï¼‰
  if (!isDesktop()) {
    $status.textContent = 'å³å°‡ç‚ºæ‚¨é–‹å•Ÿ LINEâ€¦';
    const timer = setTimeout(() => {
      $status.innerHTML = 'è‹¥æœªè·³è½‰ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ã€‚';
      showOpenButton();
    }, 1500);
    window.location.href = oaMessageURL;
    // ä¿éšªï¼šæ–°åˆ†é å†å˜—è©¦
    setTimeout(()=>{ window.open(oaMessageURL, '_blank'); }, 1800);
    return;
  }

// æ¡Œæ©Ÿï¼šåƒ…é¡¯ç¤º QRï¼Œä¸é¡¯ç¤ºæŒ‰éˆ•
$status.textContent = 'è«‹ä½¿ç”¨æ‰‹æ©Ÿ LINE æƒæä¸‹æ–¹ QR é–‹å•Ÿå„ªæƒ ã€‚';
showQR();
return;
})();
</script>
</body>
</html>
